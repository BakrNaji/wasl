{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container" dir="rtl" style="padding:30px 0; margin-top:100px;">
  <div class="row justify-content-center">
    <div class="col-lg-9">
      <!-- Employee Info Card -->
      <div class="card" style="border-radius:12px; padding:25px; border:3px solid #235E88; background:#f8f9fa; margin-bottom:20px;">
        <div class="row align-items-center">
          <div class="col-md-3 text-center">
            {% if investor.user_photo %}
              <img src="{{ investor.user_photo.url }}" alt="{{ investor.user.username }}" style="width:120px; height:120px; border-radius:50%; border:3px solid #235E88; object-fit:cover;">
            {% else %}
              <div style="width:120px; height:120px; border-radius:50%; border:3px solid #235E88; background:#ddd; margin:0 auto; display:flex; align-items:center; justify-content:center; font-size:18px; color:#666;">ğŸ‘¤</div>
            {% endif %}
          </div>
          <div class="col-md-9">
            <h3 style="color:#235E88; margin:0 0 10px 0; font-weight:700;">ğŸ‘¤ {{ investor.user.username }}</h3>
            <p style="margin:8px 0; color:#666; font-size:16px;"><strong>ğŸ“ Ø§Ù„ÙØ±Ø¹:</strong> {{ investor.branch.name|default:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            <p style="margin:8px 0; color:#666; font-size:16px;"><strong>ğŸ¢ Ø§Ù„Ù‚Ø³Ù…:</strong> {{ investor.department.name|default:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
            <p style="margin:8px 0; color:#666; font-size:16px;"><strong>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> {{ investor.user.email|default:'---' }}</p>
            {% if overall_rating > 0 %}
              <div style="margin-top:12px; padding:12px; background:#fff; border-radius:8px; border-left:4px solid #F2A23F;">
                <span style="color:#F2A23F; font-weight:700; font-size:18px;">â­ {{ overall_rating }}/5</span>
                <span style="color:#666; margin-left:10px;"> ({{ eval_count }} ØªÙ‚ÙŠÙŠÙ…)</span>
              </div>
            {% else %}
              <div style="margin-top:12px; padding:12px; background:#fff; border-radius:8px; border-left:4px solid #ddd; color:#999;">
                <span>ğŸ”˜ Ù„Ù… ÙŠØªÙ… ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø¹Ø¯</span>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Evaluation Form Card -->
      <div class="card" style="border-radius:12px; padding:25px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
        <h4 class="mb-4" style="color:#235E88; font-weight:700; display:flex; align-items:center; gap:10px;">â­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h4>
        
        {% include 'parts/_alerts.html' %}
        
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row g-4">
            <!-- Branch & Department Selection (Hidden for now, auto-filled from investor) -->
            <input type="hidden" name="branch" value="{{ investor.branch.id|default:'' }}" />
            <input type="hidden" name="department" value="{{ investor.department.id|default:'' }}" />

            <!-- Evaluation Criteria Section -->
            <div class="col-12">
              <h5 style="color:#235E88; font-weight:700; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #F2A23F;">ğŸ“Š Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ¸Ù Ø¹Ù„ÙŠÙ‡Ø§</h5>
            </div>

            <!-- Criteria Selection Checkboxes -->
            <div class="col-12">
              <div id="criteria-checkboxes" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                {# render dynamic criteria fields provided by the form #}
                {% for name, field in form.fields.items %}
                  {% if name|startswith:'criterion_' %}
                    <label style="display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.borderColor='#235E88'; this.style.background='#f0f7ff';" onmouseout="this.style.borderColor='#ddd'; this.style.background='';">
                      <input type="checkbox" class="criterion-checkbox" data-criterion="{{ name }}" style="width:18px; height:18px; cursor:pointer;" />
                      <span style="color:#235E88; font-weight:600; font-size:16px;">{{ field.label }}</span>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
            </div>

            <!-- Dynamic Criteria Scores Display -->
            <div class="col-12">
              <div id="selected-criteria" style="display:none; margin-top:20px;">
                <h5 style="color:#235E88; font-weight:700; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #F2A23F;">â­ Ø£Ø¯Ø®Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h5>
                <div id="criteria-scores-container" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:15px;">
                  {# render dynamic criteria fields provided by the form #}
                  {% for name, field in form.fields.items %}
                    {% if name|startswith:'criterion_' %}
                      <div class="criterion-score-field" data-criterion="{{ name }}" style="display:none; background:#f8f9fa; padding:18px; border-radius:10px; border:2px solid #235E88;">
                        <label class="form-label" style="color:#235E88; font-weight:700; margin-bottom:15px; display:block; font-size:16px;">{{ field.label }}</label>
                        
                        <!-- Slider Input -->
                        <div style="margin-bottom:15px;">
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span style="color:#666; font-size:14px;">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø¬Ø©:</span>
                            <span style="font-size:28px; font-weight:700; color:#F2A23F;" class="score-display" data-for="{{ name }}">3</span>
                            <span style="color:#666; font-size:14px;">/ 5</span>
                          </div>
                          <input type="range" name="{{ name }}" class="score-slider" data-criterion="{{ name }}" min="1" max="5" value="3" style="width:100%; height:8px; border-radius:5px; background:#ddd; outline:none; cursor:pointer; accent-color:#235E88;" />
                        </div>
                        
                        <!-- Star Rating Display -->
                        <div style="display:flex; gap:6px; justify-content:center; margin-bottom:15px;">
                          {% for star in "12345" %}
                            <span class="star" data-for="{{ name }}" data-star="{{ star }}" style="font-size:28px; cursor:pointer; transition:all 0.2s; opacity:0.3; user-select:none;">â˜…</span>
                          {% endfor %}
                        </div>

                        <div style="background:#fff; padding:12px; border-radius:6px; border-left:4px solid #F2A23F; text-align:center;">
                          <small style="color:#999; display:block; margin-bottom:6px;">Ø§Ù„Ø¯Ø±Ø¬Ø©:</small>
                          <div style="font-weight:700; color:#235E88; font-size:24px;" class="score-text" data-for="{{ name }}">3</div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Comments Section -->
            <div class="col-12">
              <h5 style="color:#235E88; font-weight:700; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #F2A23F;">ğŸ’¬ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„</h5>
            </div>
            <div class="col-12">
              <label class="form-label" style="color:#235E88; font-weight:600;">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù</label>
              {{ form.comment }}
              <small style="color:#666;">Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© ØªØ³Ø§Ø¹Ø¯ ÙÙŠ ØªÙ‚ÙŠÙŠÙ… Ø´Ø§Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
            </div>

            <!-- Images Section -->
            <div class="col-12">
              <h5 style="color:#235E88; font-weight:700; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #F2A23F;">ğŸ–¼ï¸ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„ØµÙˆØ±</h5>
            </div>
            <div class="col-12">
              <label class="form-label" style="color:#235E88; font-weight:600;">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ± Ø£Ùˆ Ù…Ù„ÙØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <div style="border:2px dashed #235E88; border-radius:8px; padding:20px; text-align:center; cursor:pointer;" id="file-drop-zone">
                <input type="file" name="images" multiple class="form-control" style="display:none;" id="file-input" />
                <div style="color:#666; font-size:16px;">
                  <p>ğŸ“ Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                  <small>(PNG, JPG, GIF)</small>
                </div>
              </div>
              <div id="file-preview" style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;"></div>
            </div>

            <!-- Action Buttons -->
            <div class="col-12" style="margin-top:20px; padding-top:20px; border-top:2px solid #eee;">
              <div style="display:flex; gap:10px; justify-content:flex-end;">
                <a href="{% url 'investor_list' %}" class="btn" style="background:#6c757d; color:#fff; padding:10px 20px; border-radius:6px; text-decoration:none; font-weight:600;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
                <button type="submit" class="btn" style="background:#235E88; color:#fff; padding:10px 30px; border-radius:6px; border:none; font-weight:600; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#1a4563'" onmouseout="this.style.background='#235E88';">âœ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Previous Evaluations Card -->
      {% if recent_evaluations %}
      <div class="card" style="border-radius:12px; padding:25px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-top:25px;">
        <h4 class="mb-4" style="color:#235E88; font-weight:700; display:flex; align-items:center; gap:10px;">ğŸ“‹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
        
        {% for eval in recent_evaluations %}
        <div style="padding:15px; margin-bottom:15px; background:#f8f9fa; border-radius:8px; border-right:4px solid #F2A23F;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
              <strong style="color:#235E88; font-size:16px;">{{ eval.evaluator.user.username }}</strong>
              <span style="color:#999; margin-left:15px; font-size:14px;">{{ eval.created_at|date:'d/m/Y' }}</span>
            </div>
            {% if eval.compute_overall %}
            <span style="background:#F2A23F; color:#fff; padding:6px 12px; border-radius:6px; font-weight:700; font-size:16px;">â­ {{ eval.compute_overall|floatformat:1 }}/5</span>
            {% endif %}
          </div>
          {% if eval.comment %}
          <p style="margin:10px 0; color:#666; font-size:15px;">ğŸ’¬ {{ eval.comment }}</p>
          {% endif %}
          {% if eval.image %}
          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
            {% for img in eval.image_set.all %}
            <a href="{{ img.image.url }}" target="_blank" style="display:inline-block; width:60px; height:60px; border-radius:6px; overflow:hidden; border:2px solid #ddd;">
              <img src="{{ img.image.url }}" style="width:100%; height:100%; object-fit:cover;" />
            </a>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Criteria Selection & Scoring Script -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const checkboxes = document.querySelectorAll('.criterion-checkbox');
  const selectedCriteriaDiv = document.getElementById('selected-criteria');
  const sliders = document.querySelectorAll('.score-slider');
  const stars = document.querySelectorAll('.star');
  
  function updateCriteriaDisplay(){
    const checkedCriteria = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.criterion);
    
    // show/hide criteria score fields
    document.querySelectorAll('.criterion-score-field').forEach(field => {
      const criterion = field.dataset.criterion;
      field.style.display = checkedCriteria.includes(criterion) ? 'block' : 'none';
    });
    
    // show/hide the scores container
    selectedCriteriaDiv.style.display = checkedCriteria.length > 0 ? 'block' : 'none';
  }
  
  // Update score display when slider changes
  sliders.forEach(slider => {
    slider.addEventListener('input', function(){
      const criterion = this.dataset.criterion;
      const value = this.value;
      
      // Update display text
      document.querySelectorAll(`.score-display[data-for="${criterion}"]`).forEach(el => {
        el.textContent = value;
      });
      document.querySelectorAll(`.score-text[data-for="${criterion}"]`).forEach(el => {
        el.textContent = value;
      });
      
      // Update stars
      document.querySelectorAll(`.star[data-for="${criterion}"]`).forEach((star, idx) => {
        if(parseInt(star.dataset.star) <= value){
          star.style.opacity = '1';
          star.style.color = '#F2A23F';
        } else {
          star.style.opacity = '0.3';
          star.style.color = '#666';
        }
      });
    });
  });
  
  // Click stars to set score
  stars.forEach(star => {
    star.addEventListener('click', function(){
      const criterion = this.dataset.for;
      const starValue = parseInt(this.dataset.star);
      
      // Find and update the slider
      const slider = document.querySelector(`.score-slider[data-criterion="${criterion}"]`);
      if(slider){
        slider.value = starValue;
        slider.dispatchEvent(new Event('input'));
      }
    });
    
    star.addEventListener('mouseover', function(){
      const criterion = this.dataset.for;
      const starValue = parseInt(this.dataset.star);
      
      // Highlight stars on hover
      document.querySelectorAll(`.star[data-for="${criterion}"]`).forEach((s, idx) => {
        if(parseInt(s.dataset.star) <= starValue){
          s.style.opacity = '1';
        } else {
          s.style.opacity = '0.3';
        }
      });
    });
  });
  
  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateCriteriaDisplay);
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const fileInput = document.getElementById('file-input');
  const fileDropZone = document.getElementById('file-drop-zone');
  const filePreview = document.getElementById('file-preview');

  // click to select
  fileDropZone.addEventListener('click', () => fileInput.click());

  // drag and drop
  fileDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileDropZone.style.background = '#e7f3ff';
    fileDropZone.style.borderColor = '#235E88';
  });
  fileDropZone.addEventListener('dragleave', () => {
    fileDropZone.style.background = '';
    fileDropZone.style.borderColor = '#235E88';
  });
  fileDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    fileInput.files = e.dataTransfer.files;
    updateFilePreview();
    fileDropZone.style.background = '';
  });

  fileInput.addEventListener('change', updateFilePreview);

  function updateFilePreview(){
    filePreview.innerHTML = '';
    Array.from(fileInput.files).forEach((file, idx) => {
      const preview = document.createElement('div');
      preview.style.cssText = 'position:relative; width:80px; height:80px; border-radius:8px; overflow:hidden; background:#f0f0f0; display:flex; align-items:center; justify-content:center;';
      if(file.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.innerHTML = `<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
        };
        reader.readAsDataURL(file);
      } else {
        preview.innerHTML = `<span style="font-size:24px;">ğŸ“„</span>`;
      }
      const remove = document.createElement('button');
      remove.type = 'button';
      remove.textContent = 'âœ•';
      remove.style.cssText = 'position:absolute; top:-8px; right:-8px; width:24px; height:24px; background:#FF4444; color:#fff; border:none; border-radius:50%; cursor:pointer; font-weight:bold;';
      remove.addEventListener('click', (e) => {
        e.preventDefault();
        const dt = new DataTransfer();
        Array.from(fileInput.files).forEach((f, i) => { if(i !== idx) dt.items.add(f); });
        fileInput.files = dt.files;
        updateFilePreview();
      });
      preview.appendChild(remove);
      filePreview.appendChild(preview);
    });
  }
});
</script>

<style>
input[type="text"], input[type="email"], input[type="number"], textarea, select {
  border: 1.5px solid #ddd !important;
  border-radius: 6px !important;
  padding: 10px !important;
  font-size: 15px !important;
  transition: all 0.2s !important;
}
input[type="text"]:focus, input[type="email"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
  border-color: #235E88 !important;
  box-shadow: 0 0 0 3px rgba(35, 94, 136, 0.1) !important;
}
textarea {
  min-height: 100px !important;
}
</style>
{% endblock %}